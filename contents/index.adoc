= Building Kotlin JVM Libraries
:source-highlighter: highlightjs
:sample-proj-name: my-kotlin-library

This guide walks you through creating a https://kotlinlang.org[Kotlin] library for the JVM, using https://github.com/gradle/kotlin-dsl[Gradle's Kotlin DSL] for the build scripts.

== What you’ll build

You'll create a Kotlin library with the standard project layout, add a test to verify behavior, and generate API documentation for it.

If you get stuck at any point, you can check out the https://github.com/gradle-guides/building-kotlin-jvm-libraries/tree/master/samples/code/my-kotlin-library[finished sample project].

== What you’ll need

 - About +++<span class="time-to-complete-text"></span>+++
 - A text editor or IDE
 - A http://www.oracle.com/technetwork/java/javase/downloads/index.html[Java Development Kit] (JDK), version 1.8 or better
 - A https://gradle.org/install[Gradle distribution], version {gradle-version} or better

== Create a Kotlin project

First, create a directory for the project itself and then `cd` into it:

[source,console,subs="attributes"]
----
$ mkdir {sample-proj-name}
$ cd {sample-proj-name}
----

You'll be aiming to create the following overall directory and file structure:

.Kotlin project structure
[source,console,subs="attributes"]
----
include::{samplesoutputdir}/step-1/tree.out[]
----

Now, run the following commands to manually create the standard directory structure for a Gradle Kotlin project:

[source,console]
----
$ mkdir -p src/main/kotlin/org/example
$ mkdir -p src/test/kotlin/org/example 
----

[NOTE]
.On Windows
====
Don't include the `-p` option and use backslashes for the path. `mkdir` should create all the directories in the path if command extensions are enabled.
====

Using a text editor or IDE, add the following file:

.src/main/kotlin/org/example/MyLibrary.kt
[source,kotlin]
----
include::{samplescodedir}/step-1/src/main/kotlin/org/example/MyLibrary.kt[]
----

Now add the following settings file, which ensures that the project name remains the same regardless of what directory it's in:

.settings.gradle.kts
[source,kotlin,subs="attributes"]
----
include::{samplescodedir}/step-1/settings.gradle.kts[]
----

As a final step, add the following build script:

.build.gradle.kts
[source,kotlin]
----
include::{samplescodedir}/step-1/build.gradle.kts[tags=apply-kotlin-plugin]

include::{samplescodedir}/step-1/build.gradle.kts[tags=configure-dependencies]

include::{samplescodedir}/step-1/build.gradle.kts[tags=set-version]
----
<1> Applies the Kotlin plugin, targeting the Java platform. The plugin provides the majority of the build functionality you require.
<2> Declares a {user-manual}dependency_management_terminology.html#sub:terminology_repository[dependency repository] on Bintray's JCenter.
<3> Declares a dependency on the https://kotlinlang.org/api/latest/jvm/stdlib/index.html[Kotlin standard library] for compilation and runtime.
<4> Configures the group ID under which this library will be published.

The project is now ready to be built.

== Build the library

The Gradle build provides several different tasks that you can run in order to achieve different things. For now, you'll execute a full build that compiles the Kotlin code, runs any tests, and packages the library as a JAR.

To do all that, run this command:

[source,console]
----
$ gradle build
----

Once the build finishes, you'll find the compiled classes under `build/classes/kotlin/main` and the resulting packaged JAR file at `build/libs/{sample-proj-name}-1.0-SNAPSHOT.jar`.

== Add a Gradle Wrapper

The {user-manual}gradle_wrapper.html[Gradle Wrapper] is a mechanism that allows users to build a project without having Gradle installed. It also ties the build to a specific version of Gradle, which helps make the build reproducible.

Generate the necessary files by running this command:

[source,console]
$ gradle wrapper

From this point on, you'll {guides}/creating-new-gradle-builds/#switch_to_wrapper[switch to using the Gradle Wrapper].

== Add testing with JUnit

http://junit.org/junit4/[JUnit 4] is the simplest of testing libraries to add to your project. If you happen to prefer the http://spekframework.org/[Spek framework] for Kotlin-based specifications, check out the https://spekframework.org/setup-jvm/#gradle[Spek docs for Gradle].

Start by inserting a dependency on JUnit in the build script:

.build.gradle.kts
[source,diff]
----
dependencies {
    implementation(kotlin("stdlib", "1.2.31"))
    testImplementation("junit:junit:4.12")  // <1>
}
----
<1> Adds a compile-time test dependency on JUnit

Next, add the following unit test class for the `MyLibrary` class you created earlier:

.src/test/kotlin/org/example/MyLibraryTest.kt
[source,kotlin]
----
include::{samplescodedir}/step-2/src/test/kotlin/org/example/MyLibraryTest.kt[]
----

There's nothing unexpected here. Now run the tests using this command:

[source,console]
----
$ ./gradlew check
----

You can see the results of the tests by opening the HTML test report generated at `build/reports/tests/test/index.html`.

TIP: If you want to run just the unit tests, then you can execute the `test` task directly. `check`, which depends on `test`, will also run any other verification steps your build has, such as static code analysis.

== Add docs with Dokka

A library isn't done until it's documented. https://github.com/Kotlin/dokka[Dokka] is a popular documentation engine for Kotlin projects that you will use for your project.

First, apply the Dokka plugin — you can find the latest version on the https://plugins.gradle.org/plugin/org.jetbrains.dokka[Gradle Plugin Portal]:

.build.gradle.kts
[source,kotlin]
----
include::{samplescodedir}/step-3/build.gradle.kts[tags=apply-dokka-plugin]
----

Next, configure the Dokka Plugin to produce an HTML report using this block of code, which we suggest you put at the end of the build script (it _must_ come after the `plugins {}` block):

.build.gradle.kts
[source,kotlin]
----
include::{samplescodedir}/step-3/build.gradle.kts[tags=configure-dokka-plugin]
----
<1> Configures the existing `dokka` task to generate HTML to a typical output directory.

There are many more configuration options available for Dokka, documented on https://github.com/Kotlin/dokka#using-dokka[Dokka's GitHub page].

You're now ready to generate the HTML API documentation for the project using the `dokka` task, like so:

.Generate docs with Dokka
[source,console]
----
$ ./gradlew dokka

include::{samplesoutputdir}/step-3/dokka.out[]
----

You will see warnings from Dokka that you didn't document everything, but don't worry about that. You can still see the docs if you open up `build/javadoc/{sample-proj-name}/index.html`. Select the `Language` type to see how the Javadoc comments appear in the report.

image::dokka.png[]

As a last step, you will package the HTML API documentation into a JAR that can be published alongside the library JAR. Add a new task of type `Jar` to the build script using the following:

.build.gradle.kts
[source,kotlin]
----
include::{samplescodedir}/step-3/build.gradle.kts[tags=configure-dokka-jar]
----
<1> Creates a new `dokkaJar` task of type `Jar`.
<2> Specifies that the `Jar` task should archive the {user-manual}more_about_tasks.html#sec:up_to_date_checks[declared outputs] of the `dokka` task. This automatically sets up a task dependency from `dokkaJar` to `dokka`, so no `dependsOn()` configuration is needed.

When you run `./gradlew dokkaJar`, you should find the packaged documentation at `build/libs/{sample-proj-name}-1.0-SNAPSHOT-javadoc.jar`.

TIP: You can add `import` lines to the build script for both the `DokkaTask` and `Jar` task types Just be aware that they must go at the top of the build script, before everything else.

== See what other plugins are applied to your build

You may not realize this, but the Kotlin Plugin also applies the Java Plugin. You can see this by creating a build scan and looking at the list of plugins applied to the build.

To do that, run this command:

[source,console]
----
$ ./gradlew build --scan
----

You'll see output similar to the following once the build has finished:

[listing]
----
...
Publishing build scan...
https://gradle.com/s/vah36msduhfiu
----

Just open the equivalent link from your build in a browser and you'll see a report that gives you a lot of information about that build. For now, select the _Plugins_ view in the left-hand navigation, as shown here:

image::build-scan-plugins.png[]

Remember that you only explicitly declared the Kotlin and Dokka Plugins, but there are several more in that list. Of most interest are the {user-manual}java_plugin.html[Java Plugin] and {user-manual}base_plugin.html[Base Plugin] as they provide many of the conventions and tasks that you'll use day to day in your Kotlin builds. For example, the Base Plugin provides the `build` and `clean` tasks.

Since the Kotlin Plugin applies the Java Plugin, it's also well worth looking at the user manual's chapter on {user-manual}building_java_projects.html[Building Java & JVM projects] to learn more about JVM-based builds.

== Next Steps

We hope you found this fun and enlightening. Let us know what you thought of this guide via https://twitter.com/gradle[@gradle on Twitter].

 - Learn about what your build is doing and how it performs by {guides}/creating-build-scans/[creating a build scan]
 - Learn how to {user-manual}publishing_overview.html[publish your library]
 - Learn more about the https://kotlinlang.org/docs/reference/using-gradle.html[Gradle Kotlin Plugin from the official docs].
 - JetBrains has developed a series of https://github.com/JetBrains/kotlin-examples[Kotlin example projects] that demonstrate how to work with Kotlin and Gradle, including https://github.com/JetBrains/kotlin-examples/tree/master/gradle/dokka-gradle-example[one for advanced Dokka usage].
 - There are lots of https://github.com/gradle/kotlin-dsl/tree/master/samples[Kotlin DSL samples] available in the gradle/kotlin-dsl repository on GitHub, as well as additional https://github.com/gradle/kotlin-dsl/tree/master/doc/getting-started[getting started docs]

include::contribute[repo-path="gradle-guides/building-kotlin-jvm-libraries"]
